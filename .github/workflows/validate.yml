name: Validate Immunity Data

on:
  push:
    branches: [ "main" ]
    paths:
      - 'data/**.json'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'data/**.json'

jobs:
  validate-json:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install JSON Linter
        run: sudo npm install -g jsonlint

      - name: Validate Status JSON
        run: jsonlint -q data/status.json
        
      - name: Validate Blocklist JSON
        run: jsonlint -q data/blocklist.json

      - name: Validate Certs JSON
        run: jsonlint -q data/certs.json

      - name: Verify Cert Format (Simple Regex)
        run: |
          # Checks that all SHA256 hashes are exactly 64 characters of hex
          grep -o '"sha256": "[^"]*"' data/certs.json | awk -F'"' '{print $4}' | grep -vE '^[A-Fa-f0-9]{64}$' && exit 1 || echo "All cert hashes valid."
